<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat History</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/save.css">
  <style>
    /* ‡πÉ‡∏™‡πà CSS ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/"><img src="/images/Logoo.png" alt="Logo"></a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/upload">‡∏•‡∏á‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/save-offer">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notifications">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/settings">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
          </li>
        </ul>
        <span class="navbar-text me-3">
          <%= name %>
        </span>
        <a href="/logout" class="btn btn-danger">Logout</a>
      </div>
    </div>
  </nav>

  <div class="d-flex flex-grow-1">
    <div class="sidebar">
      <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢</h2>
      <div id="chat-partners"></div>
    </div>
    <div class="chat">
      <div class="messages" id="chat-messages"></div>
      <div class="input-area d-flex align-items-center">
        <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
        <button id="send-message" class="btn btn-primary">‡∏™‡πà‡∏á</button>
        <label class="camera-icon ms-2">
          üì∑
          <input type="file" class="hidden-file-input" accept="image/*" />
        </label>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendMessageButton = document.getElementById('send-message');
      const fileInput = document.querySelector('.hidden-file-input');
      const chatPartners = document.getElementById('chat-partners');
      const userName = '<%= name %>';
      const userID = '<%= userID %>';
      const socket = io({
        query: `userName=${userName}`
      });

      function loadChatPartners() {
    fetch('/chat-partners')
        .then(response => response.json())
        .then(data => {
            chatPartners.innerHTML = '';
            data.forEach(partner => {
                const partnerElement = document.createElement('div');
                partnerElement.classList.add('contact');
                partnerElement.textContent = partner.product_user;
                partnerElement.addEventListener('click', () => {
                    loadChatHistory(partner.product_user);
                });
                chatPartners.appendChild(partnerElement);
            });
        })
        .catch(error => console.error('Error fetching chat partners:', error));
}


      function loadChatHistory(productUser) {
  fetch(`/chat-history/${userName}/${productUser}`)
    .then(response => response.json())
    .then(data => {
      chatMessages.innerHTML = '';
      chatMessages.dataset.productUser = productUser;
      data.forEach(msg => {
        if (msg.image_url) {
          displayImageMessage(msg);
        } else {
          displayMessage(msg);
        }
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => console.error('Error fetching chat history:', error));
}


      sendMessageButton.addEventListener('click', () => {
        const message = chatInput.value;
        if (message.trim() !== '') {
          const msg = {
            message,
            user_name: userName,
            productUser: chatMessages.dataset.productUser,
            userID: userID,
            time: new Date().toLocaleString()
          };
          socket.emit('chat message', msg);
          chatInput.value = '';
        }
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          sendImage(file);
        }
      });
      socket.on('chat message', (msg) => {
  if ((msg.user_name === userName && msg.productUser === chatMessages.dataset.productUser) ||
      (msg.user_name === chatMessages.dataset.productUser && msg.productUser === userName)) {
    displayMessage(msg);
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadChatHistory ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  }
});

socket.on('chat image', (msg) => {
  if ((msg.user_name === userName && msg.productUser === chatMessages.dataset.productUser) ||
      (msg.user_name === chatMessages.dataset.productUser && msg.productUser === userName)) {
    displayImageMessage(msg);
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadChatHistory ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  }
});



      socket.on('chat history', (messages) => {
        chatMessages.innerHTML = '';
        messages.forEach(msg => {
          if (msg.image_url) {
            displayImageMessage(msg);
          } else {
            displayMessage(msg);
          }
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      socket.on('update chat partners', (data) => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
        const partnerExists = Array.from(chatPartners.children).some(partner => partner.textContent === data.product_user || partner.textContent === data.user_name);
        if (!partnerExists) {
          const partnerElement = document.createElement('div');
          partnerElement.classList.add('contact');
          partnerElement.textContent = data.user_name === userName ? data.product_user : data.user_name;
          partnerElement.addEventListener('click', () => {
            loadChatHistory(partnerElement.textContent);
          });
          chatPartners.appendChild(partnerElement);
        }
      });


      function displayMessage(msg) {
  const messageElement = document.createElement('div');
  messageElement.classList.add('message');
  messageElement.classList.add(msg.user_name === userName ? 'sent' : 'received');
  messageElement.innerHTML = `<div class="text">${msg.message}</div><small>${msg.time || new Date().toLocaleString()}</small>`;
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
}

function displayImageMessage(msg) {
  const messageElement = document.createElement('div');
  messageElement.classList.add('message');
  messageElement.classList.add(msg.user_name === userName ? 'sent' : 'received');
  const imgElement = document.createElement('img');
  imgElement.src = msg.image_url;
  imgElement.alt = "Chat Image";
  imgElement.style.maxWidth = '100%'; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ
  messageElement.appendChild(imgElement);
  messageElement.innerHTML += `<br><small>${msg.time || new Date().toLocaleString()}</small>`;
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
}


      function sendImage(imageFile) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const maxSize = 500; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxSize) {
                height *= maxSize / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width *= maxSize / height;
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(function(blob) {
              const formData = new FormData();
              formData.append('image', blob, imageFile.name);

              fetch('/upload', {
                  method: 'POST',
                  body: formData
                })
                .then(response => response.json())
                .then(data => {
                  if (data.imageUrl) {
                    const msg = {
                      imageUrl: data.imageUrl,
                      user_name: userName,
                      productUser: chatMessages.dataset.productUser,
                      userID: userID,
                      time: new Date().toLocaleString()
                    };
                    socket.emit('chat image', msg);
                  }
                })
                .catch(error => console.error('Error uploading image:', error));
            }, 'image/jpeg');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(imageFile);
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      loadChatPartners();
    });
  </script>

</body>

</html>